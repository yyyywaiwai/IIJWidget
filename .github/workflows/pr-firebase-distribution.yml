name: PR Firebase Distribution

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

concurrency:
  group: pr-firebase-distribution-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

env:
  PROJECT: IIJWidget.xcodeproj
  SCHEME: IIJWidget
  BUNDLE_ID: jp.yyyywaiwai.IIJWidget
  WIDGET_BUNDLE_ID: jp.yyyywaiwai.IIJWidget.RemainingDataWidget
  EXPORT_METHOD: development
  CODE_SIGN_STYLE: automatic
  CODE_SIGN_IDENTITY: Apple Distribution

jobs:
  distribute:
    name: Archive & Distribute
    if: ${{ github.event.pull_request.draft == false }}
    runs-on: macos-15
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Restore Firebase config
        env:
          GOOGLE_SERVICE_INFO_PLIST: ${{ secrets.GOOGLE_SERVICE_INFO_PLIST }}
        run: |
          set -euo pipefail
          if [ -z "$GOOGLE_SERVICE_INFO_PLIST" ]; then
            echo 'GOOGLE_SERVICE_INFO_PLIST secret is not configured' >&2
            exit 1
          fi
          echo "$GOOGLE_SERVICE_INFO_PLIST" | base64 --decode > IIJWidget/GoogleService-Info.plist

      - name: Prepare build paths
        run: |
          echo "ARCHIVE_PATH=$RUNNER_TEMP/IIJWidget.xcarchive" >> "$GITHUB_ENV"
          echo "EXPORT_PATH=$RUNNER_TEMP/export" >> "$GITHUB_ENV"

      - name: Select Xcode 26.0
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.0'

      - name: Resolve Swift package dependencies
        run: xcodebuild -project "$PROJECT" -scheme "$SCHEME" -resolvePackageDependencies

      - name: Create export options
        env:
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -euo pipefail
          EXPORT_OPTIONS_PLIST="$RUNNER_TEMP/exportOptions.plist"
          cat <<EOF2 > "$EXPORT_OPTIONS_PLIST"
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
            <dict>
              <key>compileBitcode</key>
              <false/>
              <key>destination</key>
              <string>export</string>
              <key>method</key>
              <string>$EXPORT_METHOD</string>
              <key>manageAppVersionAndBuildNumber</key>
              <false/>
              <key>signingStyle</key>
              <string>automatic</string>
              <key>stripSwiftSymbols</key>
              <true/>
              <key>teamID</key>
              <string>$TEAM_ID</string>
            </dict>
          </plist>
          EOF2
          echo "EXPORT_OPTIONS_PLIST=$EXPORT_OPTIONS_PLIST" >> "$GITHUB_ENV"

      - name: Prepare App Store Connect API key
        env:
          ASC_API_KEY_P8: ${{ secrets.ASC_API_KEY_P8 }}
          ASC_API_KEY_ID: ${{ secrets.ASC_API_KEY_ID }}
          ASC_API_KEY_ISSUER_ID: ${{ secrets.ASC_API_KEY_ISSUER_ID }}
        run: |
          set -euo pipefail
          if [ -z "$ASC_API_KEY_P8" ] || [ -z "$ASC_API_KEY_ID" ] || [ -z "$ASC_API_KEY_ISSUER_ID" ]; then
            echo 'App Store Connect API key secrets are missing' >&2
            exit 1
          fi
          ASC_KEY_PATH="$RUNNER_TEMP/AuthKey.p8"
          echo "$ASC_API_KEY_P8" | base64 --decode > "$ASC_KEY_PATH"
          chmod 600 "$ASC_KEY_PATH"
          {
            echo "ASC_KEY_PATH=$ASC_KEY_PATH"
            echo "ASC_KEY_ID=$ASC_API_KEY_ID"
            echo "ASC_ISSUER_ID=$ASC_API_KEY_ISSUER_ID"
          } >> "$GITHUB_ENV"

      - name: Archive IIJWidget
        env:
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -o pipefail
          xcodebuild \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -configuration Release \
            -archivePath "$ARCHIVE_PATH" \
            -destination 'generic/platform=iOS' \
            -allowProvisioningUpdates \
            -authenticationKeyPath "$ASC_KEY_PATH" \
            -authenticationKeyID "$ASC_KEY_ID" \
            -authenticationKeyIssuerID "$ASC_ISSUER_ID" \
            clean archive

      - name: Export IPA
        run: |
          set -o pipefail
          mkdir -p "$EXPORT_PATH"
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath "$EXPORT_PATH" \
            -exportOptionsPlist "$EXPORT_OPTIONS_PLIST" \
            -allowProvisioningUpdates \
            -authenticationKeyPath "$ASC_KEY_PATH" \
            -authenticationKeyID "$ASC_KEY_ID" \
            -authenticationKeyIssuerID "$ASC_ISSUER_ID"

      - name: Locate IPA
        id: ipa
        run: |
          IPA_PATH=$(find "$EXPORT_PATH" -type f -name '*.ipa' | head -n 1)
          if [ -z "$IPA_PATH" ]; then
            echo 'IPA file not found' >&2
            exit 1
          fi
          echo "path=$IPA_PATH" >> "$GITHUB_OUTPUT"

      - name: Upload to Firebase App Distribution
        id: firebase
        uses: wzieba/Firebase-Distribution-Github-Action@v1.7.1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          groups: ${{ secrets.FIREBASE_DISTRIBUTION_GROUPS }}
          testers: ${{ secrets.FIREBASE_DISTRIBUTION_TESTERS }}
          file: ${{ steps.ipa.outputs.path }}
          releaseNotes: |
            PR #${{ github.event.pull_request.number }} · ${{ github.event.pull_request.title }}
            Author: ${{ github.event.pull_request.user.login }}
            Commit: ${{ github.sha }}

      - name: Notify Discord
        if: ${{ success() }}
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          RELEASE_URL: ${{ steps.firebase.outputs.release-url }}
          DOWNLOAD_URL: ${{ steps.firebase.outputs.release-download-url }}
        run: |
          set -euo pipefail
          if [ -z "$WEBHOOK_URL" ]; then
            echo 'Discord webhook URL is not configured' >&2
            exit 1
          fi
          LINK="$RELEASE_URL"
          if [ -z "$LINK" ]; then
            LINK="$DOWNLOAD_URL"
          fi
          if [ -z "$LINK" ]; then
            echo 'Firebase action did not return a release link' >&2
            exit 1
          fi
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          COMMIT_SHA="${{ github.sha }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          PAYLOAD=$(jq -n \
            --arg link "$LINK" \
            --arg pr "#$PR_NUMBER · $PR_TITLE" \
            --arg commit "$COMMIT_SHA" \
            --arg author "$AUTHOR" \
            '{
              embeds: [
                {
                  title: "新しい PR ビルドが利用可能",
                  description: "[Install build](" + $link + ")",
                  color: 5793266,
                  fields: [
                    {name: "PR", value: $pr},
                    {name: "Commit", value: $commit},
                    {name: "Author", value: $author}
                  ],
                  footer: {text: "Firebase App Distribution"}
                }
              ]
            }')
          curl -X POST -H 'Content-Type: application/json' -d "$PAYLOAD" "$WEBHOOK_URL"
