name: PR Discord Notify

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
  workflow_dispatch:

concurrency:
  group: pr-discord-notify-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  notify:
    name: Notify Discord
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.draft == false }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Notify Discord
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "$WEBHOOK_URL" ]; then
            echo 'Discord webhook URL is not configured' >&2
            exit 1
          fi

          RUN_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          COMMIT_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"
          COMMIT_SHORT=${GITHUB_SHA:0:7}
          PR_NUMBER=$(jq -r '.pull_request.number // empty' "$GITHUB_EVENT_PATH")
          PR_TITLE=$(jq -r '.pull_request.title // empty' "$GITHUB_EVENT_PATH")
          PR_AUTHOR=$(jq -r '.pull_request.user.login // empty' "$GITHUB_EVENT_PATH")
          HEAD_SHA=$(jq -r '.pull_request.head.sha // empty' "$GITHUB_EVENT_PATH")

          COMMIT_MESSAGE=""
          if [ -n "$HEAD_SHA" ]; then
            COMMIT_MESSAGE=$(curl -sS \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "$GITHUB_API_URL/repos/$GITHUB_REPOSITORY/commits/$HEAD_SHA" | jq -r '.commit.message // empty')
          else
            COMMIT_MESSAGE=$(jq -r '.head_commit.message // empty' "$GITHUB_EVENT_PATH")
          fi
          COMMIT_MESSAGE_LINE=$(printf '%s' "$COMMIT_MESSAGE" | head -n 1 | cut -c1-120)
          if [ -z "$COMMIT_MESSAGE_LINE" ]; then
            COMMIT_MESSAGE_LINE="(no message)"
          fi

          if [ -n "$PR_NUMBER" ] && [ -n "$PR_TITLE" ]; then
            PR_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/pull/$PR_NUMBER"
            EMBED_TITLE="PR が更新されました"
            EMBED_DESCRIPTION="[PR #$PR_NUMBER]($PR_URL) · [Commit]($COMMIT_URL) · [Actions Run]($RUN_URL)"
            EMBED_FIELDS=$(jq -n \
              --arg pr "#$PR_NUMBER · $PR_TITLE" \
              --arg author "$PR_AUTHOR" \
              --arg commit "$COMMIT_SHORT" \
              --arg message "$COMMIT_MESSAGE_LINE" \
              '[
                {name: "PR", value: $pr, inline: false},
                {name: "Author", value: $author, inline: true},
                {name: "Commit", value: $commit, inline: true},
                {name: "Message", value: $message, inline: false}
              ]')
          else
            EMBED_TITLE="手動トリガーが実行されました"
            EMBED_DESCRIPTION="[Commit]($COMMIT_URL) · [Actions Run]($RUN_URL)"
            EMBED_FIELDS=$(jq -n \
              --arg ref "$GITHUB_REF" \
              --arg actor "$GITHUB_ACTOR" \
              --arg commit "$COMMIT_SHORT" \
              --arg message "$COMMIT_MESSAGE_LINE" \
              '[
                {name: "Ref", value: $ref, inline: false},
                {name: "Actor", value: $actor, inline: true},
                {name: "Commit", value: $commit, inline: true},
                {name: "Message", value: $message, inline: false}
              ]')
          fi

          PAYLOAD=$(jq -n \
            --arg title "$EMBED_TITLE" \
            --arg description "$EMBED_DESCRIPTION" \
            --argjson fields "$EMBED_FIELDS" \
            '{
              embeds: [
                {
                  title: $title,
                  description: $description,
                  color: 5793266,
                  fields: $fields,
                  footer: {text: "Discord Notification"}
                }
              ]
            }')

          curl -X POST -H 'Content-Type: application/json' -d "$PAYLOAD" "$WEBHOOK_URL"
