name: Release Discord Notify

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: release-discord-notify-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  notify:
    name: Notify Discord
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Notify Discord
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          set -euo pipefail
          if [ -z "$WEBHOOK_URL" ]; then
            echo 'Discord webhook URL is not configured' >&2
            exit 1
          fi

          RUN_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          COMMIT_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"
          COMMIT_SHORT=${GITHUB_SHA:0:7}

          EMBED_TITLE="main への更新がありました"
          EMBED_DESCRIPTION="[Commit]($COMMIT_URL) · [Actions Run]($RUN_URL)"
          EMBED_FIELDS=$(jq -n \
            --arg branch "$GITHUB_REF_NAME" \
            --arg actor "$GITHUB_ACTOR" \
            --arg commit "$COMMIT_SHORT" \
            --arg note "ビルド/配布は実行しません" \
            '[
              {name: "Branch", value: $branch, inline: true},
              {name: "Actor", value: $actor, inline: true},
              {name: "Commit", value: $commit, inline: true},
              {name: "Note", value: $note, inline: false}
            ]')

          PAYLOAD=$(jq -n \
            --arg title "$EMBED_TITLE" \
            --arg description "$EMBED_DESCRIPTION" \
            --argjson fields "$EMBED_FIELDS" \
            '{
              embeds: [
                {
                  title: $title,
                  description: $description,
                  color: 3447003,
                  fields: $fields,
                  footer: {text: "Discord Notification"}
                }
              ]
            }')

          curl -X POST -H 'Content-Type: application/json' -d "$PAYLOAD" "$WEBHOOK_URL"
